#include <iostream>
#include <stdio.h>
#pragma comment(lib,"ws2_32.lib")
#include <WinSock2.h>

SOCKET Connections[10000];
int ConnectionCount=0;
int flag=0;
void ClientThread(int index)
{
	char mes[30]="New user connected";
	for(int i=0;i<ConnectionCount;i++)
		{
			if(i==index)
				continue;
			send(Connections[i],mes,sizeof(mes),NULL);
		}
	char buffer[256];
	while(recv(Connections[index],buffer,sizeof(buffer),NULL)!=SOCKET_ERROR)
	{
		
		for(int i=0;i<ConnectionCount;i++)
		{
			if(i==index)
				continue;
			send(Connections[i],buffer,sizeof(buffer),NULL);
		}
	}
	char mes1[30]="One is disconected";
	for(int i=0;i<ConnectionCount;i++)
		{
			if(i==index)
				continue;
			send(Connections[i],mes1,sizeof(mes1),NULL);
		}
	ConnectionCount--;
	printf("User Disconnected, Online :%d\n",ConnectionCount);
	closesocket(Connections[index]);
}
int main()
{
	WSAData wsaData;
	WORD Version=MAKEWORD(2,1);
	if(WSAStartup(Version,&wsaData)!=0)
	{
		printf("Winsock startup failed\n");
		exit(1);
	}

	SOCKADDR_IN addr;
	int addrlen=sizeof(addr);
	addr.sin_addr.s_addr=inet_addr("127.0.0.1");
	addr.sin_port=htons(666);
	addr.sin_family=AF_INET;

	SOCKET sListen=socket(AF_INET,SOCK_STREAM,NULL);
	bind(sListen,(SOCKADDR*)&addr,sizeof(addr));
	listen(sListen,SOMAXCONN);

	SOCKET newConnect;//для поддержки соединения клиента
	for(int i=0;i<10000;i++)
	{
	newConnect =accept(sListen,(SOCKADDR*)&addr,&addrlen);
	if(newConnect==0)
	{
		printf("Failed to accept the client's connection\n");
	}
	else
		{
			ConnectionCount+=1;
		printf("New Connection\n Online: %d\n",ConnectionCount);
		char buff[30]="WELCOME! Online: ";
		char *count=new char[10];
		itoa(ConnectionCount,count,10);
		strcat(buff,count);
		send(newConnect,buff,sizeof(buff),NULL);
		Connections[i]=newConnect;
		
		CreateThread(NULL,NULL,(LPTHREAD_START_ROUTINE)ClientThread,(LPVOID)(i),NULL,NULL);
		}
	}
	
	system("pause");
	return 0;
}
